<link rel="import" href="../utilities/http.html">
<link rel="import" href="../utilities/storage.html">
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="./site.html">


<script>
    const GET_VIDEOS_REQUEST = 'GET_VIDEOS_REQUEST';
    const GET_VIDEOS_FAILURE = 'GET_VIDEOS_FAILURE';
    const GET_VIDEOS_SUCCESS = 'GET_VIDEOS_SUCCESS';

    const GET_VIDEO_REQUEST = 'GET_VIDEO_REQUEST';
    const GET_VIDEO_FAILURE = 'GET_VIDEO_FAILURE';
    const GET_VIDEO_SUCCESS = 'GET_VIDEO_SUCCESS';


    const getVideosRequest = () => ({
        type: GET_VIDEOS_REQUEST,
        payload:{
            fetching: true,
        }
    });
    const getVideosSuccess = videos => ({
        type: GET_VIDEOS_SUCCESS,
        payload:{
            fetching: false,
            ...videos
        }
    });

    const getVideosFailure = () => ({
        type: GET_VIDEOS_FAILURE,
        payload:{
            fetching: false,
        }
    });

    const getVideoRequest = () => ({
        type: GET_VIDEO_REQUEST,
        payload:{
            fetching: true,
        }
    });
    const getVideoSuccess = video => ({
        type: GET_VIDEO_SUCCESS,
        payload:{
            fetching: false,
            ...video
        }
    });

    const getVideoFailure = () => ({
        type: GET_VIDEO_FAILURE,
        payload:{
            fetching: false,
        }
    });


    const VideosActions = Polymer.dedupingMixin(function(superClass){
        return class VideosActions extends superClass {
            constructor() {
               super();
            }

            getDashboardVideos() {
                return dispatch => {
                    dispatch(getVideosRequest());
                    graphql(`query {
                            videos {
                                id
                                title
                                description
                                filethumbnail
                                user {name}
                            }
                    }`)
                    .then(res => {
                        dispatch(getVideosSuccess(res.data.data));
                    })
                    .catch(err => console.log(err));
                }
            }

        getVideo() {
            return dispatch => {
                dispatch(getVideoRequest());
                graphql(`query {
                    video(id:${this.id}) {
                        title
                        description
                        filevideo
                        viewCount
                        filethumbnail
                        comments {
                            user {
                                name
                            }
                            content
                        }
                    }
                }`)
                .then(res => {
                    dispatch(getVideoSuccess(res.data.data));
                })
                .catch(err => console.log(err));
            }
        }


        uploadVideo() {
            return dispatch => {
                let mimetype = this.files[0].type
                let filename = this.files[0].name;
                let filesize = this.files[0].size;

                if (mimetype.indexOf("video/mp4") == -1) {
                    dispatch(dispatchError({
                        error: "Bad Request",
                        code: 400,
                        message: `Only supporting video/mp4 video format. ${mimetype} given`
                    }));

                    this.$.inputVideo.inputElement.inputElement.files = null
                    return
                }
                const params = {
                    headers: {
                    'Content-Type': 'application/octet-stream',
                    'X-OriginalFilename': filename,
                    'X-OriginalFilesize': filesize,
                    'X-OriginalMimetype': mimetype,
                    },

                    onUploadProgress: progressEvent => dispatch(dispatchProgress((progressEvent.loaded / filesize) * 100))
                }

                post('/tempfile', this.files[0], params)
                    .then(res => {
                      // Redirect to other screen
                      
                      dispatch(dispatch)  
                    })
                    .catch(err => console.log("ERRROR", err));
            }
        }


        }
    });

</script>