<link rel="import" href="../utilities/http.html">
<link rel="import" href="../utilities/storage.html">
<link rel="import" href="../../bower_components/polymer/polymer.html">



<script>
    const POST_LOGIN_REQUEST = 'POST_LOGIN_REQUEST';
    const POST_LOGIN_FAILURE = 'POST_LOGIN_FAILURE';
    const POST_LOGIN_SUCCESS = 'POST_LOGIN_SUCCESS';
    const DO_LOGOUT_SUCCESS = 'DO_LOGOUT_SUCCESS';



    const postLoginRequest = () => ({
        type: POST_LOGIN_REQUEST,
        payload:{
            fetching: true,
        }
    });

    const postLoginFailure = (error) => ({
        type: POST_LOGIN_FAILURE,
        payload:{
            fetching: false,
            error
        }
    });

    const postLoginSuccess = (user) => ({
        type: POST_LOGIN_SUCCESS,
        payload:{
            fetching: false,
            ...user,
        }
    });

    const doLogoutUser = (user) => ({
        type: DO_LOGOUT_SUCCESS,
        payload:{}
    });





    const UserActions = Polymer.dedupingMixin(function(superClass){
        return class UserActions extends superClass {
            constructor() {
               super();
            }


            getUser() {
                return dispatch => {
                    get('user')
                    .then(res => console.log("USER DATA", res))
                    .catch(err => console.log("ERROR:", err));
                }
            }

            logoutUser() {
                return dispatch => {
                    dispatch(doLogoutUser());
                    clearStorage();
                }
            }

            postLogin() {
                return async (dispatch) => {
                    dispatch(postLoginRequest());
                    post('user/login', {
                        email: this.username,
                        password: this.password,
                    })
                    .then(res => {
                        const data = res.data;
                        dispatch(postLoginSuccess(data));
                        console.log(data);
                        storeObject(data);
                        window.history.pushState({}, null, '/');
                        window.dispatchEvent(new CustomEvent('location-changed'));
                    })
                    .catch(error => {
                        console.log(error);
                    });

                }
            }

            getSessionData() {
                return dispatch => {
                    const token = getStorageItem('token');
                    const email = getStorageItem('email');
                    const name = getStorageItem('name');
                    const usergroup = getStorageItem('usergroup');
                    
                    // Validate token?
                    if(token) { 
                        dispatch(postLoginSuccess({
                            token,
                            email,
                            name,
                            usergroup,
                        }))
                    }


                }
            }
        }
    });



    // graphql(`
    //     query {
    //         user(id: 1) {
    //             name
    //         }
    //     }
    // `)
    // .then(res => res.data)
    // .then(console.log)
    // .catch(console.log);

    
    // console.log(axios.post);

</script>